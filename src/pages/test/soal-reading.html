<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Ambil soal reading
    const res = await fetch('/data/reading.json');
    const data = await res.json();
    const questions = data.questions;
    const timeLimit = data.timeLimit || 3300; // detik
    const mode = localStorage.getItem('testMode') || 'ujian'; // 'ujian' atau 'latihan'

    let current = 0;
    let answers = JSON.parse(localStorage.getItem('readingAnswers') || '[]');
    if (answers.length !== questions.length) answers = Array(questions.length).fill(null);

    // Timer
    let timer = timeLimit;
    const timerSpan = document.querySelector('.timer');
    function updateTimer() {
        const m = String(Math.floor(timer / 60)).padStart(2, '0');
        const s = String(timer % 60).padStart(2, '0');
        timerSpan.textContent = `${m}:${s}`;
        if (timer <= 0) {
            submitTest();
        } else {
            timer--;
            setTimeout(updateTimer, 1000);
        }
    }
    updateTimer(); // Timer selalu aktif di semua mode

    function renderQuestion(idx) {
        const q = questions[idx];
        document.querySelector('.question-title').textContent = q.question;
        // Render opsi
        const opts = document.querySelector('.options');
        opts.innerHTML = '';
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option' + (answers[idx] === i ? ' selected' : '');
            div.textContent = opt;
            div.onclick = () => {
                answers[idx] = i;
                localStorage.setItem('readingAnswers', JSON.stringify(answers));
                renderQuestion(idx);
                renderNavigator();
                // Feedback langsung (mode latihan)
                if (mode === 'latihan') {
                    showFeedback(q, i);
                }
            };
            opts.appendChild(div);
        });
        document.querySelector('.question-number').textContent = `Question ${idx + 1} of ${questions.length}`;
        document.querySelector('.prev-btn').disabled = idx === 0;
        document.querySelector('.next-btn').disabled = idx === questions.length - 1;
        // Feedback area
        let feedback = document.getElementById('feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.id = 'feedback';
            feedback.style.marginTop = '1rem';
            feedback.style.fontWeight = 'bold';
            document.querySelector('.question-section').appendChild(feedback);
        }
        feedback.innerHTML = '';
    }

    function showFeedback(q, chosenIdx) {
        const feedback = document.getElementById('feedback');
        if (chosenIdx === q.correct) {
            feedback.innerHTML = '<span style="color:green">Benar!</span>';
        } else {
            feedback.innerHTML = `<span style="color:red">Salah.</span> Kunci: <b>${q.options[q.correct]}</b>`;
        }
    }

    function renderNavigator() {
        const nav = document.querySelector('.navigator-grid');
        nav.innerHTML = '';
        questions.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.textContent = i + 1;
            btn.className = (i === current ? 'current ' : '') +
                (answers[i] !== null ? 'answered' : 'unanswered');
            btn.onclick = () => {
                current = i;
                renderQuestion(current);
                renderNavigator();
            };
            nav.appendChild(btn);
        });
    }

    document.querySelector('.prev-btn').onclick = () => {
        if (current > 0) {
            current--;
            renderQuestion(current);
            renderNavigator();
        }
    };
    document.querySelector('.next-btn').onclick = () => {
        if (current < questions.length - 1) {
            current++;
            renderQuestion(current);
            renderNavigator();
        }
    };
    document.querySelector('.submit-btn').onclick = submitTest;

    function submitTest() {
        if (mode === 'latihan') {
            showPembahasan();
            return;
        }
        // Hitung skor
        let score = 0;
        questions.forEach((q, i) => {
            if (answers[i] === q.correct) score++;
        });
        localStorage.setItem('readingScore', score);
        localStorage.setItem('readingTotal', questions.length);
        localStorage.removeItem('readingAnswers');
        window.location.href = '/test/hasil-reading';
    }

    function showPembahasan() {
        document.querySelector('.test-container').innerHTML = `
            <div class="pembahasan-container">
                <h2 class="pembahasan-title">Pembahasan Reading</h2>
                
                <!-- Desktop Table View -->
                <div class="table-responsive">
                    <table class="table-pembahasan">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Pertanyaan</th>
                                <th>Jawaban Anda</th>
                                <th>Kunci</th>
                                <th>Pembahasan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${questions.map((q, i) => {
                                const userAns = answers[i];
                                const benar = userAns === q.correct;
                                return `
                                    <tr>
                                        <td>${i+1}</td>
                                        <td style="text-align:left">${q.question}</td>
                                        <td style="text-align:left">
                                            <span class="${userAns === null ? 'belum' : benar ? 'benar' : 'salah'}">
                                                ${userAns !== null ? q.options[userAns] : '<i>Belum dijawab</i>'}
                                            </span>
                                        </td>
                                        <td style="text-align:left"><span class="benar">${q.options[q.correct]}</span></td>
                                        <td style="text-align:left">${q.explanation || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card View -->
                <div class="pembahasan-mobile">
                    ${questions.map((q, i) => {
                        const userAns = answers[i];
                        const benar = userAns === q.correct;
                        const statusClass = userAns === null ? 'belum' : benar ? 'benar' : 'salah';
                        const statusText = userAns === null ? 'Belum dijawab' : benar ? 'Benar' : 'Salah';
                        return `
                            <div class="pembahasan-card">
                                <div class="card-header">
                                    <span class="question-number">${i + 1}</span>
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="question-text">${q.question}</div>
                                <div class="answer-section">
                                    <span class="answer-label">Jawaban Anda:</span>
                                    <div class="answer-value ${statusClass}">
                                        ${userAns !== null ? q.options[userAns] : '<i>Belum dijawab</i>'}
                                    </div>
                                </div>
                                <div class="answer-section">
                                    <span class="answer-label">Kunci Jawaban:</span>
                                    <div class="answer-value benar">${q.options[q.correct]}</div>
                                </div>
                                ${q.explanation && q.explanation !== '-' ? `
                                    <div class="explanation">
                                        <strong>Pembahasan:</strong><br>
                                        ${q.explanation}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <a href="/dashboard" class="btn-dashboard">Kembali ke Dashboard</a>
            </div>
        `;
        // Reset jawaban setelah pembahasan
        localStorage.removeItem('readingAnswers');
    }

    // Tampilkan mode aktif di pojok kanan atas
    const header = document.querySelector('.question-header');
    if (header) {
        const modeLabel = document.createElement('span');
        modeLabel.textContent = mode === 'ujian' ? 'Mode Ujian' : 'Mode Latihan';
        modeLabel.style.background = mode === 'ujian' ? '#4a55a2' : '#2ecc71';
        modeLabel.style.color = '#fff';
        modeLabel.style.padding = '0.3rem 1rem';
        modeLabel.style.borderRadius = '20px';
        modeLabel.style.marginLeft = '1rem';
        header.appendChild(modeLabel);
    }

    // Render awal
    renderQuestion(current);
    renderNavigator();
});
</script>

</body>
</html>
