<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Listening Comprehension</title>
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/pages/test/soal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <a href="/dashboard" class="btn btn-back" style="margin:1.5rem 2rem 0 2rem;">
        <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
    </a>
    <div class="test-container">
        <aside class="question-navigator">
            <div class="navigator-grid"></div>
            <button class="submit-btn">Submit Test</button>
        </aside>
        <section class="question-section">
            <div class="question-header">
                <span class="question-number"></span>
                <span class="timer">40:00</span>
            </div>
            <h2 class="question-title"></h2>
            <div class="options"></div>
            <div class="navigation-buttons">
                <button class="prev-btn">Previous</button>
                <button class="next-btn">Next</button>
            </div>
        </section>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', async function() {
    // Ambil soal reading
    const res = await fetch('../../data/reading.json');
    const data = await res.json();
    const questions = data.questions;
    const timeLimit = data.timeLimit || 3300; // detik
    const mode = localStorage.getItem('testMode') || 'ujian'; // 'ujian' atau 'latihan'

    let current = 0;
    let answers = JSON.parse(localStorage.getItem('readingAnswers') || '[]');
    if (answers.length !== questions.length) answers = Array(questions.length).fill(null);

    // Timer
    let timer = timeLimit;
    const timerSpan = document.querySelector('.timer');
    function updateTimer() {
        const m = String(Math.floor(timer / 60)).padStart(2, '0');
        const s = String(timer % 60).padStart(2, '0');
        timerSpan.textContent = `${m}:${s}`;
        if (timer <= 0) {
            submitTest();
        } else {
            timer--;
            setTimeout(updateTimer, 1000);
        }
    }
    updateTimer(); // Timer selalu aktif di semua mode

    function renderQuestion(idx) {
        const q = questions[idx];
        document.querySelector('.question-title').textContent = q.question;
        // Render opsi
        const opts = document.querySelector('.options');
        opts.innerHTML = '';
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option' + (answers[idx] === i ? ' selected' : '');
            div.textContent = opt;
            div.onclick = () => {
                answers[idx] = i;
                localStorage.setItem('readingAnswers', JSON.stringify(answers));
                renderQuestion(idx);
                renderNavigator();
                // Feedback langsung (mode latihan)
                if (mode === 'latihan') {
                    showFeedback(q, i);
                }
            };
            opts.appendChild(div);
        });
        document.querySelector('.question-number').textContent = `Question ${idx + 1} of ${questions.length}`;
        document.querySelector('.prev-btn').disabled = idx === 0;
        document.querySelector('.next-btn').disabled = idx === questions.length - 1;
        // Feedback area
        let feedback = document.getElementById('feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.id = 'feedback';
            feedback.style.marginTop = '1rem';
            feedback.style.fontWeight = 'bold';
            document.querySelector('.question-section').appendChild(feedback);
        }
        feedback.innerHTML = '';
    }

    function showFeedback(q, chosenIdx) {
        const feedback = document.getElementById('feedback');
        if (chosenIdx === q.correct) {
            feedback.innerHTML = '<span style="color:green">Benar!</span>';
        } else {
            feedback.innerHTML = `<span style="color:red">Salah.</span> Kunci: <b>${q.options[q.correct]}</b>`;
        }
    }

    function renderNavigator() {
        const nav = document.querySelector('.navigator-grid');
        nav.innerHTML = '';
        questions.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.textContent = i + 1;
            btn.className = (i === current ? 'current ' : '') +
                (answers[i] !== null ? 'answered' : 'unanswered');
            btn.onclick = () => {
                current = i;
                renderQuestion(current);
                renderNavigator();
            };
            nav.appendChild(btn);
        });
    }

    document.querySelector('.prev-btn').onclick = () => {
        if (current > 0) {
            current--;
            renderQuestion(current);
            renderNavigator();
        }
    };
    document.querySelector('.next-btn').onclick = () => {
        if (current < questions.length - 1) {
            current++;
            renderQuestion(current);
            renderNavigator();
        }
    };
    document.querySelector('.submit-btn').onclick = submitTest;

    function submitTest() {
        if (mode === 'latihan') {
            showPembahasan();
            return;
        }
        // Hitung skor
        let score = 0;
        questions.forEach((q, i) => {
            if (answers[i] === q.correct) score++;
        });
        localStorage.setItem('readingScore', score);
        localStorage.setItem('readingTotal', questions.length);
        localStorage.removeItem('readingAnswers');
        window.location.href = 'hasil-reading.html';
    }

    function showPembahasan() {
        document.querySelector('.test-container').innerHTML = `
            <div class="pembahasan-container">
                <h2 class="pembahasan-title">Pembahasan Reading</h2>
                <div class="table-responsive">
                    <table class="table-pembahasan">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Pertanyaan</th>
                                <th>Jawaban Anda</th>
                                <th>Kunci</th>
                                <th>Pembahasan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${questions.map((q, i) => {
                                const userAns = answers[i];
                                const benar = userAns === q.correct;
                                return `
                                    <tr>
                                        <td>${i+1}</td>
                                        <td style="text-align:left">${q.question}</td>
                                        <td style="text-align:left">
                                            <span class="${userAns === null ? 'belum' : benar ? 'benar' : 'salah'}">
                                                ${userAns !== null ? q.options[userAns] : '<i>Belum dijawab</i>'}
                                            </span>
                                        </td>
                                        <td style="text-align:left"><span class="benar">${q.options[q.correct]}</span></td>
                                        <td style="text-align:left">${q.explanation || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <a href="/dashboard" class="btn-dashboard">Kembali ke Dashboard</a>
            </div>
            <style>
            .pembahasan-container {
                max-width: 980px;
                margin: 2.5rem auto;
                background: #fff;
                border-radius: 18px;
                padding: 2.5rem 1.5rem 2rem 1.5rem;
                box-shadow: 0 4px 24px #e3eafc;
                animation: fadeIn 0.7s;
            }
            .pembahasan-title {
                margin-bottom: 2rem;
                font-size: 2rem;
                color: #2d3a4a;
                letter-spacing: 0.5px;
                text-align: center;
            }
            .table-responsive { overflow-x: auto; }
            .table-pembahasan {
                border-collapse: separate;
                border-spacing: 0;
                width: 100%;
                font-size: 1.07em;
                background: #fafdff;
                box-shadow: 0 1px 8px #f0f4fa;
            }
            .table-pembahasan th, .table-pembahasan td {
                border: 1px solid #e0e0e0;
                padding: 13px 10px;
                vertical-align: top;
            }
            .table-pembahasan th {
                background: #e3eafc;
                position: sticky;
                top: 0;
                z-index: 2;
                font-weight: 600;
                color: #223;
                text-align: center;
            }
            .table-pembahasan tr:nth-child(even) { background: #f6faff; }
            .table-pembahasan tr:hover { background: #eaf2fb; transition: background 0.2s; }
            .benar {
                color: #219150;
                font-weight: 600;
                background: #e7fbe9;
                border-radius: 6px;
                padding: 2px 8px;
            }
            .salah {
                color: #d32f2f;
                font-weight: 600;
                background: #ffeaea;
                border-radius: 6px;
                padding: 2px 8px;
            }
            .belum {
                color: #888;
                font-style: italic;
            }
            .btn-dashboard {
                margin-top: 2.2rem;
                display: inline-block;
                background: #2471f3;
                color: #fff;
                padding: 0.8em 2.2em;
                border: none;
                border-radius: 8px;
                font-size: 1.1em;
                font-weight: 500;
                box-shadow: 0 2px 8px #e3eafc;
                transition: background 0.2s, box-shadow 0.2s;
                text-decoration: none;
                cursor: pointer;
            }
            .btn-dashboard:hover {
                background: #1746a2;
                box-shadow: 0 4px 16px #dbeafe;
            }
            @media (max-width: 700px) {
                .pembahasan-container { padding: 1rem 0.2rem; }
                .table-pembahasan th, .table-pembahasan td { font-size: 0.97em; padding: 7px 4px; }
                .pembahasan-title { font-size: 1.2rem; }
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(30px);}
                to { opacity: 1; transform: none;}
            }
            </style>
        `;
        // Reset jawaban setelah pembahasan
        localStorage.removeItem('readingAnswers');
    }

    // Tampilkan mode aktif di pojok kanan atas
    const header = document.querySelector('.question-header');
    if (header) {
        const modeLabel = document.createElement('span');
        modeLabel.textContent = mode === 'ujian' ? 'Mode Ujian' : 'Mode Latihan';
        modeLabel.style.background = mode === 'ujian' ? '#4a55a2' : '#2ecc71';
        modeLabel.style.color = '#fff';
        modeLabel.style.padding = '0.3rem 1rem';
        modeLabel.style.borderRadius = '20px';
        modeLabel.style.marginLeft = '1rem';
        header.appendChild(modeLabel);
    }

    // Render awal
    renderQuestion(current);
    renderNavigator();
});
</script>
</body>
</html>